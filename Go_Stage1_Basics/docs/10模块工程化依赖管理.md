# Go Modules 工程化依赖管理

> 适用版本：Go 1.16+（默认启用，无需手动开启）
>
> 核心定位：Go 官方**项目依赖管理工具**，负责管理第三方包、版本控制、依赖隔离

------

## 1. 概述

### 1.1 是什么

Go Modules 是 Go 语言官方的**模块化依赖管理方案**，用来统一管理项目中使用的第三方库（如 Gin、Redis 客户端、Protobuf 等），保证项目可移植、可重复构建、依赖不冲突。

一句话总结：

**Go Modules = 项目的「专属依赖管家」**

### 1.2 解决了什么痛点

在 Go Modules 出现前，所有项目必须放在 `GOPATH` 目录下，依赖全局共享，极易出现：

- 项目必须固定存放位置，不灵活
- 不同项目依赖同一个库的**不同版本**，直接冲突
- 无法精确锁定依赖版本，换环境就跑不起来
- 无法管理间接依赖

Go Modules 彻底解决以上问题。

------

## 2. 核心概念

### 2.1 Module（模块）

- 包含 `go.mod` 文件的**目录**就是一个模块
- 是 Go 项目的**最小管理单元**
- 一个模块 = 一个项目 + 它的所有依赖

### 2.2 go.mod（模块清单文件）

模块的**核心配置文件**，记录：

- 模块名称（唯一标识）
- 项目使用的 Go 版本
- 直接依赖的第三方包及版本
- 可选：替换依赖、排除版本

### 2.3 go.sum（依赖校验文件）

- 记录所有依赖包的**加密哈希值**
- 用于校验依赖包是否被篡改、保证完整性
- 由 Go 自动维护，**无需手动修改**

### 2.4 语义化版本（SemVer）

Go 统一使用的版本格式：

plaintext

```go
v主版本.次版本.补丁版本
例：v1.9.1
```

- 主版本：不兼容的大更新
- 次版本：兼容的功能更新
- 补丁版本：兼容的 bug 修复

------

## 3. GOPATH vs Go Modules（对比记忆）

| 特性         | 旧模式 GOPATH         | 新模式 Go Modules |
| :----------- | :-------------------- | :---------------- |
| 项目存放位置 | 必须放在 `GOPATH/src` | **任意目录均可**  |
| 依赖隔离     | 全局共享，易冲突      | 项目级独立隔离    |
| 版本控制     | 无精确版本管理        | 支持锁定版本      |
| 可重复构建   | 很难保证              | 自动保证          |
| 第三方代理   | 不支持                | 完美支持          |

------

## 4. 核心命令（必背）

### 4.1 初始化模块（新项目必用）

```go
# 格式：go mod init [模块名]
# 模块名一般用：github名/项目名 或 自定义名称
go mod init github.com/your-name/go-demo
```

### 4.2 整理依赖（最常用！）

```
go mod tidy
```

作用：

- 自动下载项目需要的依赖

- 自动删除 `go.mod` 中没用的依赖

- 自动更新 

  ```go
  go.sum
  ```

  写完代码后必执行

### 4.3 安装 / 更新依赖

```
# 安装最新版
go get github.com/gin-gonic/gin

# 安装指定版本
go get github.com/gin-gonic/gin@v1.9.1

# 更新到最新版
go get -u github.com/gin-gonic/gin
```

### 4.4 查看依赖

```go
# 查看所有依赖
go list -m all

# 查看某个包的所有可用版本
go list -m -versions github.com/gin-gonic/gin
```

### 4.5 下载依赖到本地

```go
go mod download
```

------

## 5. 核心文件详解

### 5.1 go.mod 完整示例

```go
// 模块唯一名称
module github.com/your-name/go-demo

// 要求的 Go 版本
go 1.21

// 项目直接依赖
require (
    github.com/gin-gonic/gin v1.9.1
    github.com/go-redis/redis/v8 v8.11.5
)

// 本地替换依赖（开发调试用）
replace github.com/gin-gonic/gin => ../local/gin

// 排除有问题的版本
exclude github.com/old/bad-package v1.0.0
```

### 5.2 go.sum 说明

- 存储依赖包哈希校验值
- 保证下载的包是完整、未被篡改的
- 提交代码时**必须一起提交**
- 不要手动编辑

------

## 6. 从零实战：创建一个 Go Modules 项目（标准流程）

### 6.1 步骤 1：创建项目目录

```
mkdir go-demo && cd go-demo
```

### 6.2 步骤 2：初始化模块

```
go mod init github.com/your-name/go-demo
```

执行后自动生成 `go.mod`。

### 6.3 步骤 3：编写代码

创建 `main.go`：

```go
package main

import (
    "fmt"
    "rsc.io/quote" // 第三方依赖
)

func main() {
    fmt.Println(quote.Hello())
}
```

### 6.4 步骤 4：自动处理依赖

```
go mod tidy
```

### 6.5 步骤 5：运行

```
go run main.go
```

### 6.6 最终目录结构

```
go-demo/
├── go.mod      // 模块清单
├── go.sum      // 校验文件
└── main.go     // 业务代码
```

------

## 7. 高级特性（了解即可）

### 7.1 replace（本地替换依赖）

用于：

- 调试本地修改过的第三方包
- 无法下载的包替换为镜像

```
replace github.com/xxx/yyy => ../local/yyy
```

### 7.2 exclude（排除版本）

拒绝使用某个有 bug 的版本：

```
exclude github.com/xxx/yyy v1.0.0
```

### 7.3 私有仓库依赖

```
# 设置私有仓库，不走代理
go env -w GOPRIVATE=github.com/your-company/*
```

------

## 8. 最佳实践（工程化规范）

1. **任何 Go 项目都必须使用 Go Modules**

2. 提交代码时必须提交：`go.mod` + `go.sum`

3. 不提交 `vendor` 目录（除非公司要求）

4. 依赖版本固定，不随意升级

5. 每次修改依赖后执行：

   ```
   go mod tidy
   ```

6. 国内开发必须配置代理：

   ```go
   go env -w GOPROXY=https://goproxy.cn,direct
   ```

------

## 9. 常见问题与解决方案

### 9.1 依赖下载失败 / 超时

```
# 配置国内代理（永久生效）
go env -w GOPROXY=https://goproxy.cn,direct
# 清理缓存重试
go clean -modcache
go mod tidy
```

### 9.2 依赖版本冲突

1. 使用 `go mod graph` 查看依赖关系
2. 使用 `replace` 强制指定版本
3. 执行 `go mod tidy` 重新整理

### 9.3 提示 `unsupported module path`

模块名不合法，改用：

- `github.com/xxx/yyy`
- `example.com/project`

------

## 10. 极简速记（面试 / 复习用）

1. Go Modules = 官方依赖管理，**取代 GOPATH**
2. 核心文件：`go.mod`（清单）、`go.sum`（校验）
3. 万能命令：
   - `go mod init` → 新建项目
   - `go mod tidy` → 整理依赖
4. 优势：任意目录、版本锁定、依赖隔离、可重复构建
5. 国内必配：`GOPROXY=https://goproxy.cn,direct`